default_pre_build                                             &&
persistent_add  I_DIR                                         &&
I_DIR="/usr/share/games/$SPELL/"                              &&

chmod  a+x  $SOURCE_DIRECTORY/enet/configure                  &&

pushd  $SOURCE_DIRECTORY/src                                  &&
sedit  's:-lGL -lGLU:-L/usr/X11R6/lib &:'  Makefile           &&

#
# Enable our custom optimizations for Cube
#
sedit  "s:-O3 -fsigned-char -fomit-frame-pointer:$CXXFLAGS:"  \
       Makefile                                               &&

#
# Modified Gentoo patches from Cube
# Original sources from http://bugs.gentoo.org/show_bug.cgi?id=104292
#
patch  shared/tools.h                                             \
       $SCRIPT_DIRECTORY/20050815-addfullpath-tools.h.patch       &&
patch  shared/tools.cpp                                           \
       $SCRIPT_DIRECTORY/20050815-addfullpath-tools.cpp.patch     &&
patch  engine/rendergl.cpp                                        \
       $SCRIPT_DIRECTORY/20050815-addfullpath-rendergl.cpp.patch  &&

#
# Add GAMES_DATADIR/GAMES_DATADIR_LEN for the above patch
# Original sources from http://bugs.gentoo.org/show_bug.cgi?id=104292
#
sedit  "5a\
#define  GAMES_DATADIR \"$I_DIR\""  shared/tools.h            &&
sedit  "6a\
#define  GAMES_DATADIR_LEN ${#I_DIR}"  shared/tools.h         &&

# Gentoo fix for parallel make
sedit  's/make -C/$(MAKE) -C/'  Makefile                      &&

popd
